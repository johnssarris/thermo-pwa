<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#0e1217">
  <!-- Fallback version; will be replaced at runtime by version.txt -->
  <meta name="app-version" content="0.0.0">
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" sizes="192x192" href="./icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="./icon-512.png">
  <title>Thermostat</title>

  <style>
    :root {
      --bg1: #0e1217;
      --bg2: #151b22;
      --glass: rgba(255,255,255,0.08);
      --glass-border: rgba(255,255,255,0.15);
      --text: #e6e9ed;
      --muted: #9aa0a6;
      --button:#26303a; --button-active:#34404d;
      --panel-bg: rgba(15,18,23,0.95);
      --panel-border-strong: rgba(255,255,255,0.08);
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg1:#eaf1fb; --bg2:#f7f9fe;
        --glass: rgba(255,255,255,0.7);
        --glass-border: rgba(0,0,0,0.08);
        --text:#15202b; --muted:#5b6670;
        --button:#eef2f6; --button-active:#e2e8ef;
        --panel-bg: rgba(255,255,255,0.96);
        --panel-border-strong: rgba(0,0,0,0.12);
      }
    }

    /* üîí Disable text selection globally */
    * { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; box-sizing: border-box; }
    input, textarea { -webkit-user-select: text; user-select: text; }

    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
      font-family: -apple-system, system-ui, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, var(--bg2), var(--bg1)) fixed;
      color: var(--text);
      padding-bottom: env(safe-area-inset-bottom);
    }

    .stage {
      position: relative;
      height: 100%;
      padding: max(20px, env(safe-area-inset-top)) max(20px, env(safe-area-inset-right)) max(24px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-left));
      display: grid;
      place-items: center;
    }

    .dots {
      position: absolute; inset: 0; pointer-events: none;
      background-image:
        radial-gradient(2px 2px at 10% 20%, rgba(255,255,255,0.08) 30%, transparent 30%),
        radial-gradient(2px 2px at 80% 30%, rgba(255,255,255,0.06) 30%, transparent 30%),
        radial-gradient(2px 2px at 30% 80%, rgba(255,255,255,0.05) 30%, transparent 30%);
      background-repeat: no-repeat;
    }

    .card {
      position: relative;
      width: min(420px, 92vw);
      border-radius: 18px;
      padding: 16px;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35), 0 0 0 1px rgba(255,255,255,0.04) inset;
      backdrop-filter: blur(14px) saturate(1.1);
      -webkit-backdrop-filter: blur(14px) saturate(1.1);
    }

    .row { display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .title { font-weight:700; font-size:15px; letter-spacing:.4px; color:var(--muted); }
    .title-main { margin-left: 32px; }

    .sp { height:12px; }
    .temp { font-size:56px; font-weight:800; text-align:center; line-height:1; letter-spacing:.5px; }
    @media (max-width:350px){ .temp{ font-size:42px; } }

    .badge { font-size:12px; padding:4px 8px; border-radius:999px; background:#24303b20; color:var(--muted); }
    .segments { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }

    .seg {
      background: var(--button); color: var(--text);
      border-radius:12px; padding:10px 14px; font-weight:600; font-size:14px;
      border:1px solid rgba(0,0,0,.06);
      transition: background .2s, transform .05s, border-color .2s;
      -webkit-tap-highlight-color: transparent; touch-action: manipulation;
    }
    .seg:active { transform: scale(.97); }
    .seg.active { background: var(--button-active); border-color: rgba(0,0,0,.15); }

    .btn {
      min-width:72px; background:var(--button); color:var(--text);
      border:1px solid rgba(0,0,0,.06); border-radius:14px;
      padding:18px 22px; font-size:16px; font-weight:700;
      transition: background .2s, transform .05s, border-color .2s;
    }
    .btn:active { transform: scale(.97); }
    .btn.up { background:#203b29; border-color:rgba(124,217,146,.35); }
    .btn.down { background:#3b2a20; border-color:rgba(255,184,107,.35); }

    .grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .hint { text-align:center; color:var(--muted); font-size:12px; margin-top:10px; }

    .swipe-hint{
      position: fixed;
      left: 0; right: 0;
      bottom: calc(env(safe-area-inset-bottom) + 10px);
      text-align: center;
      font-size: 12px;
      color: var(--muted, #9aa0a6);
      pointer-events: none;
      user-select: none;
      opacity: .9;
      text-shadow: 0 1px 2px rgba(0,0,0,.35);
    }

    /* ‚öôÔ∏è Settings UI */
    #settingsBtn { position:absolute; top:8px; left:8px; background:none; border:none; font-size:20px; line-height:1; padding:4px; cursor:pointer; color:var(--muted); }
    #settingsPanel{
      position:absolute; top:40px; left:8px;
      width:min(300px, calc(100% - 16px));
      background: var(--panel-bg);
      border: 1px solid var(--panel-border-strong);
      border-radius:12px;
      padding:12px;
      display:none;
      box-shadow:0 8px 24px rgba(0,0,0,.35);
      backdrop-filter: blur(10px) saturate(1.1);
      -webkit-backdrop-filter: blur(10px) saturate(1.1);
    }
    #settingsPanel header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; font-weight:700; font-size:14px; color:var(--muted); }
    #closeSettings{ background:none; border:none; font-size:18px; line-height:1; color:var(--muted); cursor:pointer; }
    .settings-row{ display:flex; align-items:center; justify-content:space-between; gap:12px; font-size:14px; margin:8px 0; }
    .settings-kv{ color:var(--muted); }

    /* Compact action grid */
    .settings-actions{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:8px;
      margin-top:10px;
    }
    .settings-actions .mini{
      display:flex; align-items:center; justify-content:center;
      padding:8px 10px;
      border-radius:10px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--glass-border);
      font-size:12px; font-weight:600; letter-spacing:.2px;
      color: var(--text);
      box-shadow: 0 1px 0 rgba(0,0,0,.15) inset;
      transition: transform .06s ease, background .2s ease, border-color .2s ease, opacity .2s;
    }
    .settings-actions .mini:active{ transform: translateY(1px) scale(.98); }
    #updateStatus { margin-top:8px; font-size:12px; color:var(--muted); }
  </style>
</head>

<body>
  <div class="stage">
    <div class="dots"></div>

    <div class="card">
      <button id="settingsBtn" aria-label="Settings">‚öôÔ∏è</button>

      <div id="settingsPanel" role="dialog" aria-modal="false" aria-labelledby="settingsTitle">
        <header>
          <div id="settingsTitle">Settings</div>
          <button id="closeSettings" aria-label="Close">‚úï</button>
        </header>
        <div class="settings-row">
          <div class="settings-kv">Version</div>
          <div><code id="appVersion">‚Äî</code></div>
        </div>
        <div class="settings-actions">
          <button class="mini" id="btnUpdate">Check for update</button>
          <button class="mini" id="btnTokenStatus">Check token</button>
          <button class="mini" id="btnTokenSave">Paste tokens</button>
          <button class="mini" id="btnApiTest">BFF test</button>
          <button class="mini" id="btnEcobeeTest">Ecobee summary</button>
        </div>
        <div id="updateStatus" aria-live="polite"></div>
      </div>

      <div class="row">
        <div class="title title-main">THERMOSTAT</div>
        <div style="display:flex;gap:6px;align-items:center;">
          <div id="badge-mode" class="badge">MODE: ‚Äî</div>
          <div id="badge-fan" class="badge">FAN: ‚Äî</div>
        </div>
      </div>

      <div class="sp"></div>
      <div id="temp" class="temp">‚Äî¬∞</div>
      <div class="hint" id="temp-hint">Setpoint</div>
      <div class="sp"></div>

      <div class="grid">
        <button class="btn up" id="btn-up">‚ñ≤ +1¬∞</button>
        <button class="btn down" id="btn-down">‚ñº ‚àí1¬∞</button>
      </div>

      <div class="sp"></div>
      <div class="title">Mode</div>
      <div class="segments" id="mode-bar">
        <button class="seg" data-mode="heat">Heat</button>
        <button class="seg" data-mode="cool">Cool</button>
        <button class="seg" data-mode="off">Off</button>
      </div>

      <div class="sp"></div>
      <div class="title">Fan</div>
      <div class="segments" id="fan-bar">
        <button class="seg" data-fan="on">On</button>
        <button class="seg" data-fan="auto">Auto</button>
      </div>
    </div>
  </div>

  <div class="swipe-hint" aria-hidden="true">Swipe up to close</div>

  <script>
    /* ---------- Local state ---------- */
    function has(k){ return localStorage.getItem(k)!==null; }
    function get(k,d){ return has(k)?localStorage.getItem(k):d; }
    function set(k,v){ localStorage.setItem(k,v); }

    if(!has("mode_state"))set("mode_state","off");
    if(!has("fan_state"))set("fan_state","auto");
    if(!has("heat_set"))set("heat_set","70");
    if(!has("cool_set"))set("cool_set","75");

    const state={mode:get("mode_state","off"),fan:get("fan_state","auto"),heat:parseInt(get("heat_set","70"),10),cool:parseInt(get("cool_set","75"),10)};

    function activeTemp(){ if(state.mode==="heat")return state.heat; if(state.mode==="cool")return state.cool; return null; }

    function render(){
      document.getElementById('badge-mode').textContent="MODE: "+state.mode.toUpperCase();
      document.getElementById('badge-fan').textContent="FAN: "+state.fan.toUpperCase();
      document.querySelectorAll('#mode-bar .seg').forEach(b=>b.classList.toggle('active',b.dataset.mode===state.mode));
      document.querySelectorAll('#fan-bar .seg').forEach(b=>b.classList.toggle('active',b.dataset.fan===state.fan));
      const t=activeTemp(),tempEl=document.getElementById('temp'),hint=document.getElementById('temp-hint');
      if(t==null){tempEl.textContent="‚Äî¬∞";hint.textContent="Setpoint (mode OFF)";document.getElementById('btn-up').disabled=true;document.getElementById('btn-down').disabled=true;}
      else{tempEl.textContent=String(t)+"¬∞";hint.textContent="Setpoint";document.getElementById('btn-up').disabled=false;document.getElementById('btn-down').disabled=false;}
    }

    function save(){set("mode_state",state.mode);set("fan_state",state.fan);set("heat_set",state.heat);set("cool_set",state.cool);}
    function changeTemp(delta){ if(activeTemp()==null)return; if(state.mode==="heat")state.heat=Math.max(40,Math.min(90,state.heat+delta)); else if(state.mode==="cool")state.cool=Math.max(40,Math.min(90,state.cool+delta)); render(); save(); }
    function setupHold(el,delta){
      let holdTimer=null,repeatTimer=null,accelTimer=null;
      const start=e=>{e.preventDefault();changeTemp(delta);
        holdTimer=setTimeout(()=>{repeatTimer=setInterval(()=>changeTemp(delta),120);
          accelTimer=setTimeout(()=>{clearInterval(repeatTimer);repeatTimer=setInterval(()=>changeTemp(delta),60);},1000);
        },380);
      };
      const stop=()=>{clearTimeout(holdTimer);clearTimeout(accelTimer);clearInterval(repeatTimer);};
      el.addEventListener('pointerdown',start,{passive:false});
      ['pointerup','pointerleave','pointercancel'].forEach(ev=>el.addEventListener(ev,stop));
      document.addEventListener('visibilitychange',()=>{if(document.hidden)stop();});
      window.addEventListener('blur',stop);
    }

    setupHold(document.getElementById('btn-up'),+1);
    setupHold(document.getElementById('btn-down'),-1);
    document.querySelectorAll('#mode-bar .seg').forEach(btn=>btn.addEventListener('click',()=>{state.mode=btn.dataset.mode;render();save();}));
    document.querySelectorAll('#fan-bar .seg').forEach(btn=>btn.addEventListener('click',()=>{state.fan=btn.dataset.fan;render();save();}));
    render();

    /* ---------- SW ---------- */
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>navigator.serviceWorker.register('./service-worker.js'));
    }

    /* ---------- Version (auto from version.txt with fallback to meta) ---------- */
    async function updateVersionLabel(){
      const meta = document.querySelector('meta[name="app-version"]');
      let ver = meta?.content || '0.0.0';
      try{
        const res = await fetch('./version.txt?ts=' + Date.now(), { cache: 'no-store' });
        if(res.ok){
          const t = (await res.text()).trim();
          if(t) ver = t;
          if(meta) meta.content = ver;
        }
      }catch{}
      document.getElementById('appVersion').textContent = ver;
    }

    /* ---------- Settings panel + update button ---------- */
    const settingsBtn=document.getElementById('settingsBtn');
    const settingsPanel=document.getElementById('settingsPanel');
    const closeSettings=document.getElementById('closeSettings');
    const btnUpdate=document.getElementById('btnUpdate');
    const updateStatus=document.getElementById('updateStatus');

    function showPanel(show){settingsPanel.style.display=show?'block':'none';}
    settingsBtn.addEventListener('click',e=>{e.stopPropagation();showPanel(settingsPanel.style.display!=='block');});
    closeSettings.addEventListener('click',()=>showPanel(false));
    document.addEventListener('click',e=>{if(settingsPanel.style.display==='block'&&!settingsPanel.contains(e.target)&&e.target!==settingsBtn)showPanel(false);});
    document.addEventListener('keydown',e=>{if(e.key==='Escape')showPanel(false);});

    async function forceUpdate(){
      if(!('serviceWorker'in navigator)){updateStatus.textContent='No service worker present.';return;}
      try{
        updateStatus.textContent='Checking for update‚Ä¶';
        const reg=await navigator.serviceWorker.getRegistration();
        await reg?.update();
        setTimeout(()=>{updateStatus.textContent='Reloading‚Ä¶';window.location.reload();},300);
      }catch(e){
        updateStatus.textContent='Update check failed.';console.error(e);
      }
    }
    btnUpdate.addEventListener('click',e=>{e.stopPropagation();forceUpdate();});

    /* ======== TEMP SETUP BUTTONS ‚Äì BFF & Ecobee wiring ======== */
    async function fetchJSON(path, init){
      const res = await fetch(path, { credentials: 'include', ...init });
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function checkTokenStatus(){
      updateStatus.textContent='Checking token‚Ä¶';
      try{
        const data = await fetchJSON('/token/status');
        updateStatus.textContent = data.hasToken ? 'Ecobee: connected' : 'Ecobee: not set';
      }catch(e){
        updateStatus.textContent='Status check failed';
        console.error(e);
      }
    }

    async function promptAndSaveTokens(){
      const access = prompt('Paste Ecobee access_token'); if(!access) return;
      const refresh = prompt('Paste Ecobee refresh_token'); if(!refresh) return;
      const expires_at = new Date(Date.now() + 45*60*1000).toISOString(); // temp bootstrap
      updateStatus.textContent='Saving‚Ä¶';
      try{
        await fetchJSON('/token/save', {
          method:'POST',
          headers:{'content-type':'application/json'},
          body: JSON.stringify({ access_token: access, refresh_token: refresh, expires_at })
        });
        updateStatus.textContent='Saved';
      }catch(e){
        updateStatus.textContent='Save failed';
        console.error(e);
      }
    }

    async function callBffTest(){
      updateStatus.textContent='Calling /api/test‚Ä¶';
      try{
        const r = await fetchJSON('/api/test');
        updateStatus.textContent = `OK @ ${new Date(r.now).toLocaleTimeString()}`;
        console.log('BFF test:', r);
      }catch(e){
        updateStatus.textContent='BFF test failed';
        console.error(e);
      }
    }

    async function callEcobeeSummary(){
      updateStatus.textContent='Calling Ecobee‚Ä¶';
      try{
        const res = await fetchJSON('/ecobee/summary');
        if(res.ok){
          const count = res.mini?.revisionListCount ?? '?';
          updateStatus.textContent = `Ecobee OK ‚Äî ${count} thermostat(s)`;
          console.log('ecobee summary:', res);
        }else{
          updateStatus.textContent = `Ecobee error: ${res.error || res.status}`;
          console.warn(res);
        }
      }catch(e){
        updateStatus.textContent='Call failed';
        console.error(e);
      }
    }

    document.getElementById('btnTokenStatus')?.addEventListener('click', e => { e.stopPropagation(); checkTokenStatus(); });
    document.getElementById('btnTokenSave')  ?.addEventListener('click', e => { e.stopPropagation(); promptAndSaveTokens(); });
    document.getElementById('btnApiTest')    ?.addEventListener('click', e => { e.stopPropagation(); callBffTest(); });
    document.getElementById('btnEcobeeTest') ?.addEventListener('click', e => { e.stopPropagation(); callEcobeeSummary(); });

    // When panel opens, show current token status and version
    settingsBtn.addEventListener('click', () => {
      setTimeout(() => {
        if (settingsPanel.style.display === 'block') {
          checkTokenStatus();
          updateVersionLabel();
        }
      }, 60);
    });

    // Also update version once on first load
    updateVersionLabel();
  </script>
</body>
</html>